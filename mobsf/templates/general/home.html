{% load static %}
<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="Mobile Security Framework (MobSF) is an automated, all-in-one mobile application (Android/iOS/Windows) pen-testing, malware analysis and security assessment framework capable of performing static and dynamic analysis.">
      <meta name="author" content="Ajin Abraham">
      <link rel="icon" href="{% static "img/favicon.ico" %}">
      <title>Mobile Security Framework - MobSF</title>
      <link rel="stylesheet" href="{% static "adminlte/dashboard/css/adminlte.min.css" %}">
      <link rel="stylesheet" href="{% static "adminlte/plugins/fontawesome-free/css/all.min.css" %}">
      <link rel="stylesheet" href="{% static "others/css/spinner.css" %}">
      <link rel="stylesheet" href="{% static "landing/css/home.css" %}">
      <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
   </head>
   <body class="landing-body text-center">
      <div class="landing-wrapper d-flex flex-column">
         <nav class="nav nav-masthead justify-content-between align-items-center">
            <div class="nav-group d-flex align-items-center">
               <a class="nav-link active" href="{% url 'recent' %}"><i class="fas fa-history mr-1"></i> SCANS</a>
               <a class="nav-link" href="{% url 'dynamic' %}"><i class="fas fa-bolt mr-1"></i> DYNAMIC ANALYZER</a>
               <a class="nav-link" href="{% url 'api_docs' %}"><i class="fas fa-code mr-1"></i> API</a>
               <a class="nav-link" href="{% url 'about' %}"><i class="fas fa-info-circle mr-1"></i> ABOUT</a>
            </div>
            <div class="brand d-flex align-items-center">
               <img src="{% static "img/mobsf_logo.png" %}" alt="MobSF Logo" height="36" width="96" />
               <span class="brand-subtitle">v{{ version }}</span>
            </div>
            <div class="nav-group d-flex align-items-center justify-content-end">
               {% if user.is_authenticated %}
               <div class="dropdown mr-2">
                  <button class="btn btn-sm btn-ghost" id="landingUserMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                     <i class="fa fa-user-circle mr-1" aria-hidden="true"></i>
                     {{ request.user.username }}
                  </button>
                  <div class="dropdown-menu dropdown-menu-right shadow-lg" aria-labelledby="landingUserMenu">
                     <span class="dropdown-item-text text-muted small">Perfil <span class="badge badge-primary ml-1">{% if user.is_staff %}Admin{% else %}{{ request.user.groups.all.0 }}{% endif %}</span></span>
                     <div class="dropdown-divider"></div>
                     <a href="{% url 'change_password' %}" class="dropdown-item"><i class="fa fa-asterisk mr-2" aria-hidden="true"></i>Change Password</a>
                     {% if user.is_staff %}<a href="{% url 'users' %}" class="dropdown-item"><i class="fa fa-users mr-2" aria-hidden="true"></i>User Management</a>{% endif %}
                     <a href="{% url 'logout' %}" class="dropdown-item text-danger"><i class="fa fa-power-off mr-2" aria-hidden="true"></i>Logout</a>
                  </div>
               </div>
               {% endif %}
               <form action="/search" method="GET" class="landing-search">
                  <div class="input-group input-group-sm">
                     <input name="query" type="text" class="form-control" placeholder="Search">
                     <div class="input-group-append">
                        <button class="btn btn-primary" type="submit" aria-label="Buscar"><i class="fas fa-search"></i></button>
                     </div>
                  </div>
               </form>
            </div>
         </nav>
         <main role="main" class="inner cover flex-grow-1 d-flex flex-column align-items-center">
            <section class="upload-card glass-card">
               <div class="upload-header">
                  <h1 class="display-5">Faça o upload de um aplicativo para iniciar a análise</h1>
                  <p class="lead">Arraste e solte seus binários móveis ou selecione um arquivo para uma avaliação instantânea com controles de execução seguros.</p>
               </div>
               <div class="execution-mode-selector">
                  <label class="font-weight-bold" for="executionMode">Modo de execução</label>
                  <select id="executionMode" name="execution_mode" class="custom-select custom-select-sm">
                     {% for mode in available_execution_modes %}
                     <option value="{{ mode }}" {% if mode == default_execution_mode %}selected{% endif %}>
                        {% if mode == 'aggressive' %}
                        Agressivo · exploração controlada
                        {% else %}
                        Padrão · somente análise
                        {% endif %}
                     </option>
                     {% endfor %}
                  </select>
                  <small class="form-text text-muted">O modo agressivo ativa automações de exploração controlada. Garanta que o dispositivo sandbox esteja isolado.</small>
               </div>
               <form id="upload_form" enctype="multipart/form-data" method="post" class="upload-form">
                  {% csrf_token %}
                  <div class="fileUpload btn btn-lg btn-primary" id="but">
                     <input type="file" name="file" id="uploadFile" placeholder="Choose File" multiple>
                     <span class="fas fa-cloud-upload-alt mr-2"></span>
                     Upload &amp; Analyze
                  </div>
                  <p class="mb-2 text-muted">ou solte o arquivo em qualquer lugar da tela</p>
                  <h5 class="lead" id="status"></h5>
                  <progress id="progressBar" value="0" max="100" class="upload-progress" ></progress>
               </form>
               <div class="status-actions">
                  <input type="download" id="package" class="form-control form-control-sm" placeholder="Download &amp; Scan package" aria-label="Pacote para download e análise" />
                  <small class="text-muted d-block mt-2">Pressione Enter para baixar um pacote remoto e iniciar a análise automaticamente.</small>
               </div>
               <div id="alert" class="alert-bar">Análise iniciada! Você será redirecionado em instantes.</div>
            </section>
            <section class="metrics-grid">
               <div class="metric-card">
                  <span class="metric-label">Na fila</span>
                  <span class="metric-value">{{ queued_tasks }}</span>
                  <span class="metric-caption">Tarefas aguardando processamento</span>
               </div>
               <div class="metric-card">
                  <span class="metric-label">Em execução</span>
                  <span class="metric-value">{{ running_tasks }}</span>
                  <span class="metric-caption">Execuções ativas controladas</span>
               </div>
               <div class="metric-card">
                  <span class="metric-label">Análises registradas</span>
                  <span class="metric-value">{{ recent_scan_count }}</span>
                  <span class="metric-caption">Resultados disponíveis no histórico</span>
               </div>
               <div class="metric-card metric-highlight">
                  <span class="metric-label">Último relatório</span>
                  {% if recent_scan %}
                  <span class="metric-value">{{ recent_scan.APP_NAME|default:recent_scan.FILE_NAME }}</span>
                  <span class="metric-caption">{{ recent_scan.PACKAGE_NAME|default:"—" }} · {{ recent_scan.TIMESTAMP|date:"d/m/Y H:i" }}</span>
                  {% else %}
                  <span class="metric-value">Nenhum ainda</span>
                  <span class="metric-caption">Envie seu primeiro binário para começar</span>
                  {% endif %}
               </div>
            </section>
            <section class="feature-grid glass-card">
               <article class="feature">
                  <div class="feature-icon"><i class="fas fa-search"></i></div>
                  <h3>Visibilidade profunda</h3>
                  <p>Relatórios correlacionam permissões, APIs sensíveis e indicadores de comportamento para priorizar riscos rapidamente.</p>
               </article>
               <article class="feature">
                  <div class="feature-icon"><i class="fas fa-sync"></i></div>
                  <h3>Fluxos mais rápidos</h3>
                  <p>O monitor de status atualizado reduz o tráfego de sondagem e mantém o feedback em tempo real durante o upload.</p>
               </article>
               <article class="feature">
                  <div class="feature-icon"><i class="fas fa-layer-group"></i></div>
                  <h3>Ambientes unificados</h3>
                  <p>Integração com análise estática e dinâmica, instrumentação Frida e APIs corporativas de forma consistente.</p>
               </article>
            </section>
         </main>
         <footer class="mastfoot mt-auto">
            <div class="inner">
               <h6>
                  <a href="{% url 'recent' %}">RECENT SCANS</a>  ·
                  <a href="{% url 'dynamic' %}">DYNAMIC ANALYZER</a>  ·
                  <a href="{% url 'api_docs' %}">API</a>   ·
                  <a href="{% url 'donate' %}">DONATE ♥</a> ·
                  <a target="_blank" rel="noopener" href="https://mobsf.github.io/docs/#/">DOCS</a>  ·
                  <a href="{% url 'about' %}">ABOUT</a>
               </h6>
               <p>&copy; {% now "Y" %}  Mobile Security Framework - MobSF {{ version }}</p>
            </div>
         </footer>
      </div>
      <div class="hidden loading">
         <div class='uil-ring-css' style='transform:scale(0.79);'>
            <div></div>
         </div>
      </div>
      <div style="visibility:hidden; opacity:0" id="drop">
         <div id="textnode">Solte o arquivo aqui!</div>
      </div>
      <script src="{% static "adminlte/plugins/jquery.min.js" %}"></script>
      <script src="{% static "adminlte/plugins/bootstrap/bootstrap.bundle.min.js" %}"></script>
      <script>
            let warning = "This is a demo MobSF instance. Anything uploaded here will be publicly available. Do you want to continue?";
            let statusPoller = null;
            const pollingInterval = 750;
            function stopStatusPolling(){
                if (statusPoller){
                    clearInterval(statusPoller);
                    statusPoller = null;
                }
            }
            function startStatusPolling(checksum){
                stopStatusPolling();
                statusPoller = setInterval(function(){
                    get_status(checksum);
                }, pollingInterval);
            }
            function load_result(url){
                hide_loader();
                var x = document.getElementById("alert");
                x.className = "alert-bar show slide-up";
                setTimeout(function () {
                    x.className = x.className.replace("show", "");
                }, 10000);
                setTimeout(function () {
                    stopStatusPolling();
                    window.location.href = url;
                }, 1000);
            }
            $('#package').keypress(function(event){
                var keycode = (event.keyCode ? event.keyCode : event.which);
                if(keycode == '13'){
                    _("status").innerText = 'Trying to download ...';
                    show_loader();
                    $.ajax({
                        url : '{% url "download_scan" %}',
                        type : "POST",
                        dataType: "json",
                        data : {
                            package: $('#package').val(),
                            execution_mode: getExecutionMode(),
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success : function(json){
                            if (json.status === 'ok'){
                                startStatusPolling(json.hash);
                                var mode = json.execution_mode || getExecutionMode();
                                var url = json.analyzer + '/' + json.hash + '/';
                                if (mode && mode !== 'standard') {
                                    url += '?mode=' + encodeURIComponent(mode);
                                }
                                load_result(url);
                            } else {
                                hide_loader();
                                _("status").innerText = json.description;
                            }
                        },
                        error : function(xhr, ajaxOptions, thrownError) {
                            hide_loader();
                            if (thrownError === 'Forbidden'){
                                _("status").innerText = "You do not have permission to download and scan!";
                            }
                        }
                    });
                }
            });
            function show_loader(){
                var loadingOverlay = document.querySelector('.loading');
                loadingOverlay.classList.remove('hidden');
            }
            function hide_loader(){
                var loadingOverlay = document.querySelector('.loading');
                loadingOverlay.classList.add('hidden');
            }
            function _(el){
                return document.getElementById(el);
            }
            function responseHandler(json, isbutton) {
                if (json.status === 'error') {
                    _("status").innerText = json.description;
                } else {
                    startStatusPolling(json.hash);
                    var mode = json.execution_mode || getExecutionMode();
                    var url = json.analyzer + '/' + json.hash + '/';
                    if (mode && mode !== 'standard') {
                        url += '?mode=' + encodeURIComponent(mode);
                    }
                    load_result(url);
                }
            }
           function get_status(checksum){
                var xhr = new XMLHttpRequest();
                xhr.open("POST", '{% url "status" %}', true);
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.status === 'ok' && response.logs.length) {
                            const last_log = response.logs[response.logs.length - 1];
                            const dotCount = Math.ceil(Math.random() * 3);
                            _("status").innerText = last_log.status + ' ' + '.'.repeat(dotCount);
                        }
                    } else {
                        console.log("Error:", xhr.statusText);
                    }
                };
                xhr.onerror = function() {
                    console.log("Failed to get scan status");
                };
                xhr.send('hash=' + checksum);
           }
            function progressHandler(event) {
                var percent = (event.loaded / event.total) * 100;
                _("progressBar").value = Math.round(percent);
                _("status").innerText = Math.round(percent) + "% Uploaded ...";
            }
            function completeHandler(event) {
                if(event.currentTarget.status === 403){
                    _("status").innerText = "You do not have permission to upload!";
                    return;
                } else {
                    var json = JSON.parse(event.target.responseText);
                    responseHandler(json);
                }
            }
            function errorHandler(event) {
                _("status").innerText = "Upload Failed!";
            }
            function abortHandler(event) {
                _("status").innerText = "Upload Aborted!";
            }
          function isValidExt(file_name){
                var val = file_name.toLowerCase();
                var regex = new RegExp("^(.{1,300}?)\.({{exts}})$");
                val = val.replace(/^.*[\\\\\/]/, '');
                if (!(regex.test(val))) {
                    _('status').innerText = "MobSF only supports APK, APKS, XAPK, AAB, JAR, AAR, SO, IPA, DYLIB, A, ZIP, and APPX files.";
                    return false;
                }
                return true;
          }
          function isValidMime(file_mime){
                if (file_mime.length < 1)
                    return true;
                var supported = [{% for mime in mimes %}'{{mime}}',{% endfor %}];
                if(supported.indexOf(file_mime) >-1)
                    return true;
                 _('status').innerText = "MIME type (" + file_mime + ") is not supported!";
                return false;
          }
         function getExecutionMode(){
                var select = document.getElementById('executionMode');
                if (!select){
                    return '{{ default_execution_mode }}';
                }
                return select.value || '{{ default_execution_mode }}';
         }
         function uploadFile(file, i) {
           try {
                if (!isValidExt(file.name) || !isValidMime(file.type)){
                    return;
                }
                _("progressBar").style.visibility = "visible";
                var url = '{% url "upload" %}'
                var xhr = new XMLHttpRequest()
                xhr.open('POST', url, true)
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                xhr.upload.addEventListener("progress", progressHandler, false);
                xhr.addEventListener("load", completeHandler, false);
                xhr.addEventListener("error", errorHandler, false);
                xhr.addEventListener("abort", abortHandler, false);
                var formdata = new FormData();
                formdata.append("file", file);
                formdata.append("execution_mode", getExecutionMode());
                xhr.send(formdata)
            } catch (e) {
                alert("Error:" + e);
            }
           }
           function handleFiles(files) {
               files = [...files]
               files.forEach(uploadFile)
           }
           var lastTarget = null;
           function isFile(evt) {
               var dt = evt.dataTransfer;
               for (var i = 0; i < dt.types.length; i++) {
                   if (dt.types[i] === "Files") {
                       return true;
                   }
               }
               return false;
           }
           window.addEventListener("dragenter", function (e) {
               if (isFile(e)) {
                   lastTarget = e.target;
                   document.querySelector("#drop").style.visibility = "";
                   document.querySelector("#drop").style.opacity = 1;
                   document.querySelector("#textnode").style.fontSize = "48px";
               }
           });
           window.addEventListener("dragleave", function (e) {
               e.preventDefault();
               if (e.target === document || e.target === lastTarget) {
                   document.querySelector("#drop").style.visibility = "hidden";
                   document.querySelector("#drop").style.opacity = 0;
                   document.querySelector("#textnode").style.fontSize = "42px";
               }
           });
           window.addEventListener("dragover", function (e) {
               e.preventDefault();
           });
           window.addEventListener("drop", function (e) {
               e.preventDefault();
               document.querySelector("#drop").style.visibility = "hidden";
               document.querySelector("#drop").style.opacity = 0;
               document.querySelector("#textnode").style.fontSize = "42px";
               if(e.dataTransfer.files.length > 0) {
                if (document.location.host === 'mobsf.live'){
                    if (confirm(warning) == true) {
                        handleFiles(e.dataTransfer.files);
                    } else {
                        return;
                    }
                } else {
                    handleFiles(e.dataTransfer.files);
                }
               }
           });
            $(document).ready(function() {
                $('input[type=file]').change(function() {
                    _('status').innerText = "";
                    if (_("uploadFile").files.length === 0) {
                        return;
                    }
                    var files = _("uploadFile").files;
                    if (document.location.host === 'mobsf.live'){
                        if (confirm(warning) == true) {
                            _("uploadFile").style.display = "none";
                            handleFiles(files);
                        } else {
                            return;
                        }
                    } else {
                        _("uploadFile").style.display = "none";
                        handleFiles(files);
                    }
                });
            });
      </script>
   </body>
</html>
